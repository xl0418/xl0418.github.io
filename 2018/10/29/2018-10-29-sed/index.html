<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Sed:a fast way to extract information from data | Liang Xu | This is Liang&#39;s blog for life and work archive.</title>

  
  <meta name="author" content="Liang Xu">
  

  
  <meta name="description" content="In the third project, a bunch of mega data are generated for analysis. However, the simulated data is too big to load in memory. Thus, I need to extract some information without opening the file. After quite a few time searching for a solution, sed command in bash language helps me out. More details about the third project is coming soon.">
  

  
  
  <meta name="keywords" content="project 3,bash,mega data,extract information">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Sed:a fast way to extract information from data"/>

  <meta property="og:site_name" content="Liang Xu"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Liang Xu" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Liang Xu</a>
    </h1>
    <p class="site-description">This is Liang&#39;s blog for life and work archive.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/about">About</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Sed:a fast way to extract information from data</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/10/29/2018-10-29-sed/" rel="bookmark">
        <time class="entry-date published" datetime="2018-10-29T07:00:00.000Z">
          2018-10-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>In the third project, a bunch of mega data are generated for analysis. However, the simulated data is too big to load in memory. Thus, I need to extract some information without opening the file. After quite a few time searching for a solution, <code>sed</code> command in bash language helps me out. More details about the third project is coming soon.</p>
<span id="more"></span>

<h2 id="The-data-file"><a href="#The-data-file" class="headerlink" title="The data file"></a>The data file</h2><p>The data file contains a few snapshot on different time points. Some matrix are written in the file when a snapshot time is hit. These matrix may be very large according to the parameter settings you chose. What I want to extract is the matrix \(\boldsymbol{D}\) and \(\boldsymbol{R}\) at the end. </p>
<p><img src="/2018-10-29-sed/rawdata.png" alt="Raw data files."></p>
<h2 id="Extracting-the-matrix"><a href="#Extracting-the-matrix" class="headerlink" title="Extracting the matrix"></a>Extracting the matrix</h2><p>Firstly, I extract all the \(\boldsymbol{D}\)s, for example, from the data file. The following code does the thing for me.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> &#123;0..4&#125;;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..4&#125;;</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">sed -n <span class="string">&#x27;/D&#x27;</span>&#123;<span class="string">&#x27;length(D)+1&#x27;</span>&#125;<span class="string">&#x27; = \[\r/,/\];/p&#x27;</span> <span class="built_in">test</span><span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.m &gt; Ds<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata</span><br><span class="line"><span class="built_in">echo</span> $j<span class="variable">$i</span><span class="string">&#x27; done&#x27;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>As you see, there are in total 25 data files I need to deal with. For each data file, <code>sed</code> finds the line starting with “\(D\left\{length(D)+1\right\} &#x3D; [\)” till “\(];\)” from the file testji.m and writes&#x2F;prints (\(p\)) all the matched lines to the file Dsji.Rdata. </p>
<p><img src="/2018-10-29-sed/ds.png" alt="All D matrix are extracted."></p>
<h2 id="Replacing-the-last-D-matrix"><a href="#Replacing-the-last-D-matrix" class="headerlink" title="Replacing the last D matrix"></a>Replacing the last D matrix</h2><p>Then, I want to extract the last  \(\boldsymbol{D}\) matrix. How can I do that? Use the following code:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> &#123;0..4&#125;;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..4&#125;;</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">A=$(grep -c <span class="string">&#x27;D&#x27;</span>&#123;<span class="string">&#x27;length(D)+1&#x27;</span>&#125;<span class="string">&#x27; = \[&#x27;</span> Ds<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata)</span><br><span class="line">B=$[<span class="variable">$A</span>-1]</span><br><span class="line">sed <span class="string">&#x27;/D&#x27;</span>&#123;<span class="string">&#x27;length(D)+1&#x27;</span>&#125;<span class="string">&#x27;/&#123;G;s/\nX\&#123;&#x27;</span><span class="variable">$B</span><span class="string">&#x27;\&#125;//;tend;x;s/^/X/;x;P;d&#125;;p;d;:end;s/D&#x27;</span>&#123;<span class="string">&#x27;length(D)+1&#x27;</span>&#125;<span class="string">&#x27;/D/;:a;n;ba&#x27;</span> Ds<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata&gt;Dt<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata</span><br><span class="line">sed -n <span class="string">&#x27;/D = \[\r/,/\];/p&#x27;</span> Dt<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata &gt; D<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata</span><br><span class="line"></span><br><span class="line">C=$(<span class="built_in">cat</span> D<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata |<span class="built_in">wc</span> -l)</span><br><span class="line">C=$[<span class="variable">$C</span>-2]</span><br><span class="line">D=$[<span class="variable">$C</span>+1]</span><br><span class="line"></span><br><span class="line">sed -i -e <span class="string">&#x27;s/D = \[/D = structure(c(/&#x27;</span> -e <span class="string">&#x27;s/\];/),.Dim=c(&#x27;</span>$(<span class="built_in">echo</span> <span class="variable">$C</span>)<span class="string">&#x27;,&#x27;</span>$(<span class="built_in">echo</span> <span class="variable">$C</span>)<span class="string">&#x27;))/&#x27;</span> -e <span class="string">&#x27;s/;/ /g&#x27;</span> -e <span class="string">&#x27;2,$&#123;s/ /,/g&#125;&#x27;</span> -e <span class="string">&#x27;2,$&#123;s/,,/ /g&#125;&#x27;</span> -e <span class="string">&#x27;3,&#x27;</span>$(<span class="built_in">echo</span> <span class="variable">$D</span>)<span class="string">&#x27;&#123;s/^/,/g&#125;&#x27;</span> D<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata</span><br><span class="line"><span class="built_in">echo</span> $j<span class="variable">$i</span><span class="string">&#x27; done&#x27;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>The command <code>grep</code> returns the number of the replicates of the line “\(D\left\{length(D)+1\right\} &#x3D; [\)”. Then <code>sed</code> replaces the head of the last matrix with \(D\) and extracts this matrix out and writes into file Dij.Rdata. As I want to work in R with these results, I reformat the structure of the results to fit the matrix format in R which is something like:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D <span class="operator">=</span> structure<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span>.Dim<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>

<p>At last, I can directly <code>source</code> the file in R and read the matrix. </p>
<p><img src="/2018-10-29-sed/d.png" alt="The last D matrix is captured."></p>
<h2 id="Details-in-sed"><a href="#Details-in-sed" class="headerlink" title="Details in sed"></a>Details in sed</h2><p>The first <code>sed</code> in the second script is the key part in this function. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;/D&#x27;</span>&#123;<span class="string">&#x27;length(D)+1&#x27;</span>&#125;<span class="string">&#x27;/&#123;G;s/\nX\&#123;&#x27;</span><span class="variable">$B</span><span class="string">&#x27;\&#125;//;tend;x;s/^/X/;x;P;d&#125;;p;d;:end;s/D&#x27;</span>&#123;<span class="string">&#x27;length(D)+1&#x27;</span>&#125;<span class="string">&#x27;/D/;:a;n;ba&#x27;</span> Ds<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata&gt;Dt<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata</span><br></pre></td></tr></table></figure>

<p>I don’t fully understand what every letter in this command means. In this <a target="_blank" rel="noopener" href="https://superuser.com/questions/394282/sed-perform-only-first-nth-matched-replacement">answer</a>, the author explained the idea is to store a \(X\) at each match in the holdspace, and when all the \(X\)s are there, loop till the end of file. If you know more, please comment after the post. Thanks!</p>
<p>The third <code>sed</code> reformats the matrix to fit in R. <code>-e</code> executes several commands in one line. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i -e <span class="string">&#x27;s/D = \[/D = structure(c(/&#x27;</span> -e <span class="string">&#x27;s/\];/),.Dim=c(&#x27;</span>$(<span class="built_in">echo</span> <span class="variable">$C</span>)<span class="string">&#x27;,&#x27;</span>$(<span class="built_in">echo</span> <span class="variable">$C</span>)<span class="string">&#x27;))/&#x27;</span> -e <span class="string">&#x27;s/;/ /g&#x27;</span> -e <span class="string">&#x27;2,$&#123;s/ /,/g&#125;&#x27;</span> -e <span class="string">&#x27;2,$&#123;s/,,/ /g&#125;&#x27;</span> -e <span class="string">&#x27;3,&#x27;</span>$(<span class="built_in">echo</span> <span class="variable">$D</span>)<span class="string">&#x27;&#123;s/^/,/g&#125;&#x27;</span> D<span class="string">&quot;$j<span class="variable">$i</span>&quot;</span>.Rdata</span><br></pre></td></tr></table></figure>

<p>The first segment replaces “\(D &#x3D; [ \)” with “\(D &#x3D; structure(c( \)” while the second replaces the tail “];” with “(,.Dim&#x3D;c(row,col)”. Then all the signs “;” are substituted by space and the single space is substituted by “,” from the second line to the end. Following the replacement of “,,” by space from the second line and add “,” at the beginning of the line from the third line on. Finally, a standard matrix form is rebuilt.  </p>
<p>BTW, a good tutorial can be found <a target="_blank" rel="noopener" href="http://www.grymoire.com/Unix/Sed.html">here</a>. Have fun! </p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Research/">Research</a>, <a href="/categories/Research/Bash/">Bash</a>, <a href="/categories/Research/Bash/sed/">sed</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/project-3/">project 3</a><a href="/tags/bash/">bash</a><a href="/tags/mega-data/">mega data</a><a href="/tags/extract-information/">extract information</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 Liang Xu
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>